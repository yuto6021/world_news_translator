# データ永続化とトラッキング機能

## 概要

World News Translatorは、**Hive**を使用した堅牢なデータ永続化システムを実装しています。Web版ではブラウザのlocalStorageが揮発する可能性がありますが、**アプリ版（Android/iOS/Windows/macOS）ではアンインストールしない限りデータが永続化**されます。

## 実装された機能

### 1. コメント永続化（CommentsService）
- **保存先**: Hive (`article_comments` box)
- **機能**:
  - 記事ごとのコメント保存・取得・削除
  - 返信（スレッド）機能
  - 絵文字リアクション（追加/削除/カウント）
  - コメント編集
- **使い方**: 記事詳細画面からコメント投稿・返信・リアクションが可能

### 2. 実測読書時間トラッキング（ReadingTimeService）
- **保存先**: Hive (`reading_time` box)
- **仕組み**:
  - 記事詳細画面を開いた瞬間に`startSession()`
  - 画面を閉じた瞬間に`endSession()`で経過時間を計測
  - **異常値フィルタ**: 5秒未満（誤タップ）と10分以上（放置）は除外
  - 累計秒数を保存し、分/時間単位で取得可能
- **Stats画面での表示**: 「○○時間○○分」形式で累計読書時間を表示

### 3. 実績システム（AchievementsService）
- **保存先**: Hive (`achievements` box)
- **デフォルト実績**:
  - 📖 **読書家の第一歩**: 累計30分読書
  - 📚 **集中力の証**: 累計2時間読書
  - 🎓 **知識の探求者**: 累計10時間読書
  - 🔥 **1週間連続**: 7日間連続ログイン
  - ⭐ **習慣化マスター**: 30日間連続ログイン
  - 👑 **不屈の意志**: 100日間連続ログイン
  - 🏆 **クイズマスター**: クイズ満点達成
  - 🌟 **クイズの天才**: クイズ満点5回達成
  - 💬 **活発な議論**: コメント10件投稿
  - ❤️ **コレクター**: お気に入り50件保存
  - 🐍 **スネークマスター**: スネーク長さ20達成
  - 🎮 **2048チャレンジャー**: 512タイル達成
  - 🎯 **ビンゴマスター**: ビンゴ完成

- **進捗トラッキング**: 各実績は進捗率（0-100%）とアンロック日時を記録
- **Stats画面での表示**: プログレスバー付きで全実績を一覧表示

### 4. ゲームスコア統合管理（GameScoresService）
- **保存先**: Hive (`game_scores` box)
- **対応ゲーム**:
  - 🎴 国旗神経衰弱
  - 👆 タップチャレンジ
  - 🐾 ペット育成
  - 🎲 数字当て
  - 🐍 スネーク
  - 🎮 2048
  - 📰 ニュースクイズ
- **機能**: ベストスコア自動保存・更新・一覧表示

### 5. その他の永続化データ
- **お気に入り**: `FavoritesService`（既存、SharedPreferences）
- **ストリーク**: `StreakService`（既存、SharedPreferences）
- **ビンゴ**: `BingoScreen`（既存、SharedPreferences）
- **設定・テーマ**: `AppSettingsService`、`ThemeService`（既存、SharedPreferences）

## Hive vs SharedPreferences

| 項目 | Hive | SharedPreferences |
|------|------|-------------------|
| **構造化データ** | ✅ JSON/複雑なオブジェクト対応 | ⚠️ 基本型のみ |
| **パフォーマンス** | ✅ 高速（メモリキャッシュ） | ⚠️ やや遅い |
| **Web対応** | ✅ IndexedDB使用 | ✅ localStorage使用 |
| **型安全性** | ✅ Box<T>で型指定可能 | ⚠️ 型変換必要 |
| **データ容量** | ✅ 大容量OK | ⚠️ 少量推奨 |

## ソーシャル機能の使い方

### 概要
`SocialScreen`では、お気に入り記事の公開と共有ができます（現在はローカルのみ）。

### 使い方
1. **Stats画面** → 「ソーシャル」ボタンをタップ
2. **「公開」トグル**: ONにすると自分のお気に入りが"公開"扱いに（将来的に他ユーザーに表示される予定）
3. **今週のトップ5**: お気に入り数上位5件を表示
4. **共有ボタン**: 各記事に「📤」ボタン → SNSやメッセージアプリで共有

### 将来的な拡張案
- ユーザーID生成（UUID）でプロフィール作成
- フォロー機能（他ユーザーのお気に入りを購読）
- いいね・コメント機能の外部公開
- ランキング（読書時間・クイズスコア・ストリーク日数）

## データが残らない場合の確認ポイント

### Web版（Chrome/Edge）
- ブラウザの「閲覧履歴データを削除」でIndexedDBがクリアされる
- シークレットモードでは終了時にデータが消える
- **解決策**: アプリ版（Windows/Android/iOS）を使用

### アプリ版
- アンインストール時にサンドボックスごと削除される
- デバイスの「ストレージ最適化」「キャッシュクリア」設定を確認
- **パッケージ名変更**で再インストール扱いになると初期化される
- **解決策**: 今後バックアップ/エクスポート機能を追加予定

### 開発中の注意点
- `flutter clean` → 再ビルドでもデータは残る（Hiveは別ディレクトリ）
- ホットリスタートではデータ永続化に影響なし
- エミュレータの「Wipe Data」実行時は消える

## 初期化フロー（main.dart）

```dart
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // 1. Hive初期化
  await Hive.initFlutter();
  
  // 2. 各種サービス初期化
  await CommentsService.init();
  await AchievementsService.init();
  await GameScoresService.init();
  await ReadingTimeService.init();
  
  // 3. .envロード
  await dotenv.load();
  
  // 4. ストリーク更新
  await StreakService.instance.onAppOpen();
  
  runApp(const WorldNewsApp());
}
```

## トラブルシューティング

### 「データが保存されない」
1. アプリ版で試す（Web版はブラウザ依存）
2. 実機/エミュレータのストレージ容量を確認
3. `flutter clean` → `flutter pub get` → 再ビルド

### 「実績が解除されない」
1. 条件を満たしているか確認（例: 30分読書 = 実際に記事を30分以上開いている）
2. Stats画面を開いて進捗を確認
3. ArticleDetailScreenを正常に閉じているか（強制終了だと計測されない）

### 「コメントが消えた」
1. Hiveボックスが正常に開いているか確認（初回起動時にエラーログをチェック）
2. デバッグモードで`CommentsService.getComments()`を直接呼び出して内容確認

## 今後の改善予定

- [ ] バックアップ/リストア機能（JSON export/import）
- [ ] クラウド同期（Firebase/Supabase）
- [ ] データマイグレーション機能（キー名変更時）
- [ ] デバッグ用データビューア画面
- [ ] アプリ内通知（実績解除時のポップアップ）
- [ ] ランキングシステム（ローカルトップ10 → グローバルランキング）
