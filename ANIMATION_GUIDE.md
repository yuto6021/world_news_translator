# 実績解除＆ゲーム演出システム

## 概要

ガチャゲームのような**派手な実績解除アニメーション**と、**スコアに応じた4段階のゲーム演出**を実装しました！

## 実装された機能

### 1. 実績レア度システム（4段階）

実績に4段階のレア度を追加し、ガチャゲームのような階級分けを実現：

| レア度 | 色 | 演出の強さ | パーティクル数 | 表示時間 | 例 |
|--------|----|-----------|--------------|---------|----|
| **コモン** | 灰色 | シンプル | 40個 | 2秒 | 読書家の第一歩、1週間連続、活発な議論 |
| **レア** | 青色 | 控えめ | 80個 | 2秒 | 集中力の証、習慣化マスター、クイズマスター、コレクター、スネークマスター |
| **エピック** | 紫色 | 派手 | 150個 | 3秒 | 知識の探求者、クイズの天才、2048チャレンジャー |
| **レジェンダリー** | 金色 | 超豪華 | 200個 | 4秒 | 不屈の意志（100日間連続ログイン） |

### 2. 実績解除アニメーション（レア度別）

**表示タイミング**: 実績を初めて達成した瞬間

**レア度別の演出差**:

#### 🏆 レジェンダリー（金色）
- 紙吹雪200個が降り注ぐ
- 強烈なグロー効果（脈動）
- 大きな回転＆弾けるスケール（elasticOut）
- 表示時間: 4秒

#### 💎 エピック（紫色）
- 紙吹雪150個
- 強めのグロー効果
- やや大きめの回転＆スケール（easeOutBack）
- 表示時間: 3秒

#### 💠 レア（青色）
- 紙吹雪80個
- 控えめなグロー
- 小さな回転＆スケール
- 表示時間: 2秒

#### ⚪ コモン（灰色）
- 紙吹雪40個（最小限）
- グロー効果なし
- 回転なし、シンプルなスケール
- 表示時間: 2秒

### 3. ゲームスコア演出（4段階）

**新機能**: 各ゲーム終了時に、スコアに応じて4段階の派手な演出を表示！

| レベル | 色 | 演出 | パーティクル | 条件例 |
|--------|----|----|------------|--------|
| **Perfect** | 金色 | 超豪華 | あり | タップ100回以上、数当て3回以内 |
| **Excellent** | 紫色 | 派手 | あり | タップ80回以上、数当て5回以内 |
| **Good** | 青色 | やや派手 | なし | タップ60回以上、数当て8回以内 |
| **Normal** | 灰色 | シンプル | なし | その他 |

**対応ゲーム**:
- 🎯 タップチャレンジ
- 🔢 数当てゲーム
- 🐍 スネーク（新記録時のみ）
- 🎮 2048（新記録時のみ）
- 🧠 ニュースクイズ（新記録時のみ）

### 4. ハイスコア更新演出（紫レベル）

**表示タイミング**: ゲームで自己ベストを更新した瞬間

**対応ゲーム**:
- 🐍 スネーク（長さ10以上で表示）
- 🎮 2048（128タイル以上で表示）
- 🧠 ニュースクイズ（スコア更新時）

**演出内容**:
- 🎊 "NEW RECORD!" の大きな文字
- 💜 紫のグラデーション背景（Epic相当）
- 💥 弾けるようなスケールアニメーション
- 📊 カウントアップアニメーション（前回ベスト → 新記録）
- ⏱️ 2秒後に自動的に閉じる

### 5. Stats画面の実績表示強化

**レア度の視覚化**:
- 🎨 レア度バッジ（コモン/レア/エピック/レジェンダリー）
- 🖼️ レア度に応じたカード枠線（解除済みのみ）
- 📈 プログレスバーの色がレア度に連動
- ✨ アイコン背景にレア度カラーの淡い色

## 使い方

### 実績解除アニメーションの発火条件

1. **読書時間実績**（レア度: コモン→レア→エピック）
   - 記事を読んで画面を閉じた瞬間に自動チェック
   - 30分/2時間/10時間のいずれかを初めて達成すると表示

2. **ストリーク実績**（レア度: コモン→レア→レジェンダリー）
   - アプリ起動時に自動チェック
   - 7/30/100日連続を初めて達成すると表示

3. **ゲームスコア実績**
   - ゲーム終了時に自動チェック
   - 条件を初めて満たすと表示

### ゲーム演出の発火条件

#### タップチャレンジ
- ゲーム終了時（10秒経過後）
- スコアに応じて自動判定:
  - Perfect: 100回以上（金色、紙吹雪あり）
  - Excellent: 80回以上（紫色、紙吹雪あり）
  - Good: 60回以上（青色）
  - Normal: その他（灰色）

#### 数当てゲーム
- 正解時
- 試行回数に応じて自動判定:
  - Perfect: 3回以内（金色、紙吹雪あり）
  - Excellent: 5回以内（紫色、紙吹雪あり）
  - Good: 8回以内（青色）
  - Normal: その他（灰色）

#### Snake/2048/クイズ
- 新記録達成時のみ、紫色のHighScoreAnimation表示

## 育成ゲームのペット画像表示

**修正内容**: `pubspec.yaml`に`pet_stage_0~3.png`を登録

```yaml
assets:
  - assets/images/pet_stage_0.png
  - assets/images/pet_stage_1.png
  - assets/images/pet_stage_2.png
  - assets/images/pet_stage_3.png
```

これにより、ペットの進化段階（卵→ひな→子供→成体）に応じた画像が正しく表示されます。

## コード構造

### 主要ファイル

#### `lib/widgets/achievement_animation.dart`
派手なアニメーションウィジェット集：
- `AchievementUnlockedAnimation`: 実績解除演出（レア度別）
- `HighScoreAnimation`: ハイスコア更新演出（紫レベル）
- `GameResultAnimation`: **新機能** ゲーム結果演出（4段階）
- `_ParticlePainter`: 紙吹雪描画（CustomPainter）
- `AchievementNotifier`: 静的ヘルパー（Overlayに表示）

#### `lib/models/achievement.dart`
実績モデルに`AchievementRarity` enum追加：
```dart
enum AchievementRarity {
  common,    // 灰色、シンプル
  rare,      // 青色、控えめ
  epic,      // 紫色、派手
  legendary, // 金色、超豪華
}
```

#### `lib/services/achievements_service.dart`
実績サービスに新規解除検知機能追加：
```dart
// 新規解除の場合はAchievementを返す
static Future<Achievement?> updateProgress(String id, int progress, int target)
```

### アニメーション表示方法

```dart
// 実績解除（レア度自動判定）
AchievementNotifier.show(context, achievement);

// ハイスコア更新（紫レベル固定）
AchievementNotifier.showHighScore(
  context,
  gameName: 'スネーク',
  score: 25,
  previousBest: 20,
);

// ゲーム結果（レベル指定）
AchievementNotifier.showGameResult(
  context,
  gameName: 'タップチャレンジ',
  score: 85,
  bestScore: 90,
  message: 'すごい！',
  level: GameResultLevel.excellent, // perfect/excellent/good/normal
);
```

## 演出レベル一覧

| 演出レベル | 用途 | 色 | パーティクル | 特徴 |
|-----------|------|----|-----------|----|
| **実績: Legendary** | 実績解除 | 金色 | 200個 | 最も派手、elasticOut、4秒表示 |
| **実績: Epic** | 実績解除 | 紫色 | 150個 | 派手、easeOutBack、3秒表示 |
| **実績: Rare** | 実績解除 | 青色 | 80個 | 控えめ、2秒表示 |
| **実績: Common** | 実績解除 | 灰色 | 40個 | シンプル、回転なし、2秒表示 |
| **ゲーム: Perfect** | ゲーム結果 | 金色 | あり | 超高得点、3秒表示 |
| **ゲーム: Excellent** | ゲーム結果 | 紫色 | あり | 高得点、3秒表示 |
| **ゲーム: Good** | ゲーム結果 | 青色 | なし | 良い得点、2秒表示 |
| **ゲーム: Normal** | ゲーム結果 | 灰色 | なし | 普通、2秒表示 |
| **ハイスコア** | 新記録 | 紫色 | なし | カウントアップ、2秒表示 |

## カスタマイズ方法

### レア度別のアニメーション強度調整

`achievement_animation.dart`の`initState()`内で各レア度のパラメータを調整：

```dart
final scaleDuration = rarity == AchievementRarity.legendary
    ? 800  // ← レジェンダリーの速度
    : rarity == AchievementRarity.epic
    ? 700
    : 600;

final particleCount = rarity == AchievementRarity.legendary
    ? 200  // ← パーティクル数
    : rarity == AchievementRarity.epic
    ? 150
    : 80;
```

### ゲーム演出の閾値変更

各ゲームの判定ロジックを編集：

```dart
// タップチャレンジ（game_screen.dart）
if (_tapCount >= 100) {      // ← Perfect閾値
  level = GameResultLevel.perfect;
} else if (_tapCount >= 80) { // ← Excellent閾値
  level = GameResultLevel.excellent;
}

// 数当てゲーム
if (_attempts <= 3) {         // ← Perfect閾値
  level = GameResultLevel.perfect;
} else if (_attempts <= 5) {  // ← Excellent閾値
  level = GameResultLevel.excellent;
}
```

## パフォーマンス考慮

- **Overlayを使用**: 既存画面を破壊せず、最前面に表示
- **シングルインスタンス**: 同時に複数表示されないよう制御
- **自動破棄**: 表示後は自動的にメモリから削除
- **条件付き表示**: 低スコアでは派手な演出を抑制（パフォーマンス最適化）
- **レア度別最適化**: コモン実績は回転・グローなしでシンプルに

## 今後の拡張案

- [ ] 実績解除時のサウンドエフェクト（レア度別）
- [ ] 連続実績解除時のコンボ演出
- [ ] 実績ガチャシステム（ランダム実績チャレンジ）
- [ ] 実績シェア機能（SNS投稿）
- [ ] 実績コレクション画面（図鑑形式）
- [ ] シークレット実績（条件非公開）
- [ ] 実績ポイント＆ショップ機能
- [ ] Flag Memory、Petへのゲーム結果演出追加
- [ ] ゲーム結果のリプレイ機能
