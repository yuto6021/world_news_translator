# 🎰 ペットガチャシステム実装ガイド

## 📦 実装完了内容

### 新機能: ペットガチャ
ガチャカプセル画像を使って、新しいペット種類を入手できるシステムを実装しました。

---

## 🎮 使い方

### アクセス方法
1. **ホーム画面** → 右上の**🐾ペットアイコン**をタップ
2. ペットガチャ画面が開きます

### ガチャの流れ
1. **100コイン**を消費してガチャを引く
2. カプセル回転演出（1.5秒）
3. レア度判定（コモン/レア/エピック/レジェンダリー）
4. 新しいペットが仲間に！
5. 自動的に図鑑登録 + ペットボックスに追加

---

## 🌟 レア度と排出率

| レア度 | 確率 | 入手できるペット |
|--------|------|------------------|
| **コモン** | 40% | アグモン、ガブモン、パタモン、テントモン |
| **レア** | 30% | グレイモン、ガルルモン、エンジェモン、カブテリモン |
| **エピック** | 20% | メタルグレイモン、ワーガルルモン、エンジェウーモン、アトラーカブテリモン |
| **レジェンダリー** | 10% | ウォーグレイモン、メタルガルルモン、セラフィモン、ヘラクレスカブテリモン |

---

## 🐾 追加されたペット種類（24種）

### コモン（成長期）
- **アグモン** - 炎属性、攻撃30
- **ガブモン** - 水属性、攻撃30
- **パタモン** - 光属性、攻撃30
- **テントモン** - 草属性、攻撃30

### レア（成熟期）
- **グレイモン** - 炎属性、攻撃50
- **ガルルモン** - 水属性、攻撃50
- **エンジェモン** - 光属性、攻撃50
- **カブテリモン** - 草属性、攻撃50

### エピック（完全体）
- **メタルグレイモン** - 炎属性、攻撃70
- **ワーガルルモン** - 水属性、攻撃70
- **エンジェウーモン** - 光属性、攻撃70
- **アトラーカブテリモン** - 草属性、攻撃70

### レジェンダリー（究極体）
- **ウォーグレイモン** - 炎属性、攻撃80
- **メタルガルルモン** - 水属性、攻撃80
- **セラフィモン** - 光属性、攻撃80
- **ヘラクレスカブテリモン** - 草属性、攻撃80

---

## 📁 変更されたファイル

### 新規作成
- `lib/screens/pet_gacha_screen.dart` - ペットガチャ画面本体

### 変更ファイル
- `lib/services/pet_service.dart` - `getBox()`メソッド追加
- `lib/services/dex_service.dart` - ペット図鑑に24種追加
- `lib/screens/home_screen.dart` - ペットガチャボタン追加

---

## 🎨 使用アセット

既存のガチャカプセル画像を使用:
```
assets/gacha/
├── gacha_capsule_common.png     (コモン演出用)
├── gacha_capsule_rare.png       (レア演出用)
├── gacha_capsule_epic.png       (エピック演出用)
└── gacha_capsule_legendary.png  (レジェンダリー演出用)
```

ペット画像（自動取得）:
```
assets/pets/{stage}/{stage}_{species}_normal.png

例:
- assets/pets/child/child_agumon_normal.png
- assets/pets/adult/adult_greymon_normal.png
- assets/pets/ultimate/ultimate_wargreymon_normal.png
```

---

## 🔧 技術仕様

### レア度抽選アルゴリズム
```dart
final roll = Random().nextInt(100);
if (roll < 40) return 'common';      // 0-39: 40%
if (roll < 70) return 'rare';        // 40-69: 30%
if (roll < 90) return 'epic';        // 70-89: 20%
return 'legendary';                  // 90-99: 10%
```

### ペット生成パラメータ
- **レベル**: 1（固定）
- **経験値**: 0
- **ステータス**: 種族とステージで自動設定
- **属性**: 種族名から自動判定
- **親密度**: 50（初期値）
- **ケア品質**: 100（最高）

### 図鑑登録
- 初入手時は「🎉 新発見！」表示
- 重複時は「✨ ゲット！」表示
- `DexService.registerPet(species)`で自動登録

---

## 🚀 今後の拡張案

### 1. コイン獲得システム
現在は固定500コインですが、以下で獲得できるように:
- 記事を読む（10コイン/記事）
- バトル勝利（20コイン/勝）
- デイリーログイン（50コイン/日）

### 2. 天井システム
- 10連続で最低レア1体確定
- 50連でエピック1体確定
- 100連でレジェンダリー1体確定

### 3. ピックアップガチャ
- 期間限定で特定ペットの排出率UP
- 季節限定ペット追加

### 4. ペット強化・進化システム
- 同じペットを複数入手で強化素材に
- レベルアップで進化可能
- ガチャで高レア度を引いても育成要素は残る

### 5. ペット交換機能
- プレイヤー間でペット交換
- レア度が同じペット同士のみ

---

## 🎯 動作確認手順

```powershell
# 1. アセット再読み込み
flutter clean
flutter pub get

# 2. 実行
flutter run

# 3. テスト手順
# - ホーム画面を開く
# - 右上の🐾アイコンをタップ
# - 「ガチャを引く」ボタンをタップ
# - カプセル回転 → ペット出現を確認
# - 図鑑登録メッセージを確認
# - ペット一覧画面で新ペットを確認
```

---

## 📊 実装統計

- **新規ファイル**: 1
- **変更ファイル**: 4
- **追加コード行数**: 約600行
- **追加ペット種類**: 24種
- **ガチャレア度**: 4段階
- **使用画像**: 既存カプセル4枚 + ペット画像（自動取得）

---

## 💡 Tips

### ペット画像が表示されない場合
- エラービルダーで🥚絵文字がフォールバック表示されます
- 対応する画像ファイルを`assets/pets/`配下に配置してください
- 命名規約: `{stage}_{species}_normal.png`

### デバッグモード
コード内の以下をコメント解除で制限なしテスト可能:
```dart
// デバッグ用：制限チェックを無効化
// if (!_canDraw) return;
```

### コイン調整
`_loadCoins()`メソッドで初期コイン数を変更:
```dart
setState(() => _coins = 999999); // 無限コイン
```

---

## 🎉 完成！

ペットガチャシステムが完全に動作します！
新しいペットを集めて、バトルや育成を楽しんでください！
